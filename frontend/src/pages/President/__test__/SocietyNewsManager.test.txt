// failing

import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import SocietyNewsManager from '../../../pages/President/SocietyNewsManager';
import { BrowserRouter } from 'react-router-dom';
import { apiClient } from '../../../api';

// Mock react-router-dom hooks
vi.mock('react-router-dom', () => {
  const originalModule = vi.importActual('react-router-dom');
  return {
    ...originalModule,
    useParams: () => ({ societyId: '123' }),
    useNavigate: () => vi.fn(),
  };
});

// Mock apiClient
vi.mock('../../api', () => {
  return {
    apiClient: {
      get: vi.fn(() => Promise.resolve({ data: [] })),
      post: vi.fn(() => Promise.resolve({ data: {} })),
      put: vi.fn(() => Promise.resolve({ data: {} })),
      delete: vi.fn(() => Promise.resolve({})),
    }
  };
});

// Mock RichTextEditor
vi.mock('../../components/RichTextEditor', () => ({
  default: ({ value, onChange, placeholder }) => (
    <div data-testid="rich-text-editor">
      <textarea
        data-testid="mock-editor"
        value={value}
        onChange={(e) => onChange(e.target.value)}
        placeholder={placeholder}
      />
    </div>
  ),
}));

// Mock NewsPublicationRequestButton
vi.mock('../../components/NewsPublicationRequestButton', () => ({
  default: ({ newsId, onSuccess, skipConfirmation }) => (
    <button 
      data-testid="publication-request-button" 
      onClick={onSuccess}
    >
      Request Publication
    </button>
  ),
}));

// Mock sample news data
const mockNewsData = [
  {
    id: 1,
    title: 'Test News 1',
    content: '<p>Test content 1</p>',
    created_at: '2023-01-01T00:00:00Z',
    updated_at: '2023-01-01T00:00:00Z',
    published_at: null,
    status: 'Draft',
    admin_notes: null,
    is_featured: false,
    is_pinned: false,
    tags: ['tag1', 'tag2'],
    view_count: 0,
    image_url: null,
    attachment_name: null,
    attachment_url: null,
    author_data: {
      id: 1,
      username: 'testuser',
      full_name: 'Test User',
    },
    comment_count: 0,
  },
  {
    id: 2,
    title: 'Test News 2',
    content: '<p>Test content 2</p>',
    created_at: '2023-01-02T00:00:00Z',
    updated_at: '2023-01-02T00:00:00Z',
    published_at: '2023-01-03T00:00:00Z',
    status: 'Published',
    admin_notes: null,
    is_featured: true,
    is_pinned: true,
    tags: ['tag3', 'tag4'],
    view_count: 10,
    image_url: 'https://example.com/image.jpg',
    attachment_name: 'test.pdf',
    attachment_url: 'https://example.com/test.pdf',
    author_data: {
      id: 2,
      username: 'testuser2',
      full_name: 'Test User 2',
    },
    comment_count: 5,
  },
  {
    id: 3,
    title: 'Test News 3',
    content: '<p>Test content 3</p>',
    created_at: '2023-01-04T00:00:00Z',
    updated_at: '2023-01-04T00:00:00Z',
    published_at: null,
    status: 'Rejected',
    admin_notes: 'Needs revision',
    is_featured: false,
    is_pinned: false,
    tags: [],
    view_count: 2,
    image_url: null,
    attachment_name: null,
    attachment_url: null,
    author_data: {
      id: 1,
      username: 'testuser',
      full_name: 'Test User',
    },
    comment_count: 0,
  },
];

const renderComponent = (props = {}) => {
  return render(
    <BrowserRouter>
      <SocietyNewsManager {...props} />
    </BrowserRouter>
  );
};

describe('SocietyNewsManager', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    
    // Setup mock responses
    apiClient.get.mockResolvedValue({ data: mockNewsData });
    apiClient.post.mockResolvedValue({ data: { id: 4, status: 'Draft' } });
    apiClient.put.mockResolvedValue({ data: { id: 1, status: 'Draft' } });
    apiClient.delete.mockResolvedValue({});
    
    // Mock browser APIs
    global.URL.createObjectURL = vi.fn(() => 'blob:mock-url');
    global.URL.revokeObjectURL = vi.fn();
    window.confirm = vi.fn(() => true);
    window.open = vi.fn();
    
    // Mock FileReader
    Object.defineProperty(window, 'FileReader', {
      writable: true,
      value: class MockFileReader {
        onloadend = null;
        result = null;
        readAsDataURL(blob) {
          this.result = 'data:image/jpeg;base64,mockbase64data';
          setTimeout(() => {
            if (this.onloadend) this.onloadend();
          }, 0);
        }
      }
    });
  });

  afterEach(() => {
    vi.restoreAllMocks();
  });

  it('renders the news list on initial load', async () => {
    renderComponent();
    
    await waitFor(() => {
      expect(apiClient.get).toHaveBeenCalledWith('/api/society/123/news/');
    });
    
    expect(screen.getByText('Society News Management')).toBeInTheDocument();
    expect(screen.getByText('All News')).toBeInTheDocument();
    
    // Check if news items are rendered
    expect(screen.getByText('Test News 1')).toBeInTheDocument();
    expect(screen.getByText('Test News 2')).toBeInTheDocument();
    expect(screen.getByText('Test News 3')).toBeInTheDocument();
  });

  it('shows loading state while fetching news', async () => {
    // Delay the API response
    apiClient.get.mockImplementation(() => 
      new Promise(resolve => 
        setTimeout(() => resolve({ data: mockNewsData }), 100)
      )
    );
    
    renderComponent();
    
    // CircularProgress should be visible during loading
    expect(screen.getByRole('progressbar')).toBeInTheDocument();
    
    // Wait for the loading to complete
    await waitFor(() => {
      expect(screen.queryByRole('progressbar')).not.toBeInTheDocument();
    });
  });

  it('shows empty state when no news are available', async () => {
    apiClient.get.mockResolvedValue({ data: [] });
    
    renderComponent();
    
    await waitFor(() => {
      expect(screen.getByText('No news posts found')).toBeInTheDocument();
      expect(screen.getByText('Create your first news post to get started')).toBeInTheDocument();
    });
  });

  it('filters news items based on selected tab', async () => {
    renderComponent();
    
    await waitFor(() => {
      expect(apiClient.get).toHaveBeenCalled();
    });
    
    // Click on Published tab
    fireEvent.click(screen.getByText('Published'));
    
    // Only published news should be visible
    expect(screen.getByText('Test News 2')).toBeInTheDocument();
    expect(screen.queryByText('Test News 1')).not.toBeInTheDocument();
    expect(screen.queryByText('Test News 3')).not.toBeInTheDocument();
    
    // Click on Drafts tab
    fireEvent.click(screen.getByText('Drafts'));
    
    // Only draft news should be visible
    expect(screen.getByText('Test News 1')).toBeInTheDocument();
    expect(screen.queryByText('Test News 2')).not.toBeInTheDocument();
    expect(screen.queryByText('Test News 3')).not.toBeInTheDocument();
    
    // Click on Rejected tab
    fireEvent.click(screen.getByText('Rejected'));
    
    // Only rejected news should be visible
    expect(screen.getByText('Test News 3')).toBeInTheDocument();
    expect(screen.queryByText('Test News 1')).not.toBeInTheDocument();
    expect(screen.queryByText('Test News 2')).not.toBeInTheDocument();
    
    // Click on All News tab
    fireEvent.click(screen.getByText('All News'));
    
    // All news should be visible again
    expect(screen.getByText('Test News 1')).toBeInTheDocument();
    expect(screen.getByText('Test News 2')).toBeInTheDocument();
    expect(screen.getByText('Test News 3')).toBeInTheDocument();
  });

  it('opens the create form when create button is clicked', async () => {
    renderComponent();
    
    await waitFor(() => {
      expect(apiClient.get).toHaveBeenCalled();
    });
    
    // Click on Create News button
    fireEvent.click(screen.getByText('Create News'));
    
    // Create form should be visible
    expect(screen.getByText('Create New News Post')).toBeInTheDocument();
    expect(screen.getByPlaceholderText('Enter compelling title...')).toBeInTheDocument();
    expect(screen.getByTestId('rich-text-editor')).toBeInTheDocument();
    expect(screen.getByText('Publication Settings')).toBeInTheDocument();
    expect(screen.getByText('Tags')).toBeInTheDocument();
    expect(screen.getByText('Media')).toBeInTheDocument();
  });

  it('displays news details when a news item is clicked', async () => {
    renderComponent();
    
    await waitFor(() => {
      expect(apiClient.get).toHaveBeenCalled();
    });
    
    // Click on View Details button of the first news
    const viewButtons = screen.getAllByText('View Details');
    fireEvent.click(viewButtons[0]);
    
    // News details should be visible
    expect(screen.getByText('News Details')).toBeInTheDocument();
    expect(screen.getByText('Test News 1')).toBeInTheDocument();
    expect(screen.getByText('Test User')).toBeInTheDocument();
    expect(screen.getByText('Draft')).toBeInTheDocument();
    expect(screen.getByText('0 views')).toBeInTheDocument();
  });

  it('opens edit form when edit button is clicked in news details', async () => {
    renderComponent();
    
    await waitFor(() => {
      expect(apiClient.get).toHaveBeenCalled();
    });
    
    // Click on View Details button of the first news
    const viewButtons = screen.getAllByText('View Details');
    fireEvent.click(viewButtons[0]);
    
    // Click on Edit button
    fireEvent.click(screen.getByText('Edit'));
    
    // Edit form should be visible
    expect(screen.getByText('Edit News Post')).toBeInTheDocument();
    
    // Form should be pre-filled with news data
    const titleInput = screen.getByPlaceholderText('Enter compelling title...');
    expect(titleInput).toHaveValue('Test News 1');
    
    const editorInput = screen.getByTestId('mock-editor');
    expect(editorInput).toHaveValue('<p>Test content 1</p>');
    
    // Tags should be visible
    expect(screen.getByText('tag1')).toBeInTheDocument();
    expect(screen.getByText('tag2')).toBeInTheDocument();
  });

  it('creates a new news post successfully', async () => {
    renderComponent();
    
    await waitFor(() => {
      expect(apiClient.get).toHaveBeenCalled();
    });
    
    // Click on Create News button
    fireEvent.click(screen.getByText('Create News'));
    
    // Fill in the form
    const titleInput = screen.getByPlaceholderText('Enter compelling title...');
    fireEvent.change(titleInput, { target: { value: 'New Test News' } });
    
    const editorInput = screen.getByTestId('mock-editor');
    fireEvent.change(editorInput, { target: { value: '<p>New test content</p>' } });
    
    // Add a tag
    const tagInput = screen.getByPlaceholderText('Add a tag...');
    fireEvent.change(tagInput, { target: { value: 'newtag' } });
    fireEvent.click(screen.getByText('Add'));
    
    // Submit the form
    const submitButton = screen.getByText('Save Draft');
    fireEvent.click(submitButton);
    
    // Check that API call was made correctly
    await waitFor(() => {
      expect(apiClient.post).toHaveBeenCalledWith(
        '/api/society/123/news/',
        expect.any(FormData),
        expect.objectContaining({
          headers: expect.objectContaining({
            'Content-Type': 'multipart/form-data',
          }),
        })
      );
      
      // Check that news list is refreshed
      expect(apiClient.get).toHaveBeenCalledTimes(2);
    });
  });

  it('edits an existing news post successfully', async () => {
    renderComponent();
    
    await waitFor(() => {
      expect(apiClient.get).toHaveBeenCalled();
    });
    
    // Click on View Details button of the first news
    const viewButtons = screen.getAllByText('View Details');
    fireEvent.click(viewButtons[0]);
    
    // Click on Edit button
    fireEvent.click(screen.getByText('Edit'));
    
    // Modify the form
    const titleInput = screen.getByPlaceholderText('Enter compelling title...');
    fireEvent.change(titleInput, { target: { value: 'Updated Test News' } });
    
    const editorInput = screen.getByTestId('mock-editor');
    fireEvent.change(editorInput, { target: { value: '<p>Updated test content</p>' } });
    
    // Submit the form
    const submitButton = screen.getByText('Save Draft');
    fireEvent.click(submitButton);
    
    // Check that API call was made correctly
    await waitFor(() => {
      expect(apiClient.put).toHaveBeenCalledWith(
        '/api/news/1/detail/',
        expect.any(FormData),
        expect.objectContaining({
          headers: expect.objectContaining({
            'Content-Type': 'multipart/form-data',
          }),
        })
      );
      
      // Check that news list is refreshed
      expect(apiClient.get).toHaveBeenCalledTimes(2);
    });
  });

  it('handles delete news functionality', async () => {
    renderComponent();
    
    await waitFor(() => {
      expect(apiClient.get).toHaveBeenCalled();
    });
    
    // Click on View Details button of the first news
    const viewButtons = screen.getAllByText('View Details');
    fireEvent.click(viewButtons[0]);
    
    // Click on Delete button
    fireEvent.click(screen.getByText('Delete'));
    
    // Check that API call was made correctly
    await waitFor(() => {
      expect(apiClient.delete).toHaveBeenCalledWith('/api/news/1/detail/');
    });
  });

  it('manages tags correctly', async () => {
    renderComponent();
    
    await waitFor(() => {
      expect(apiClient.get).toHaveBeenCalled();
    });
    
    // Click on Create News button
    fireEvent.click(screen.getByText('Create News'));
    
    // Add a tag
    const tagInput = screen.getByPlaceholderText('Add a tag...');
    fireEvent.change(tagInput, { target: { value: 'newtag' } });
    fireEvent.click(screen.getByText('Add'));
    
    // Tag should be visible
    expect(screen.getByText('newtag')).toBeInTheDocument();
    
    // Add another tag
    fireEvent.change(tagInput, { target: { value: 'secondtag' } });
    fireEvent.click(screen.getByText('Add'));
    
    // Both tags should be visible
    expect(screen.getByText('newtag')).toBeInTheDocument();
    expect(screen.getByText('secondtag')).toBeInTheDocument();
    
    // Remove a tag
    const deleteButtons = screen.getAllByRole('button', { name: /remove/i });
    fireEvent.click(deleteButtons[0]);
    
    // Only the second tag should remain
    expect(screen.queryByText('newtag')).not.toBeInTheDocument();
    expect(screen.getByText('secondtag')).toBeInTheDocument();
  });

  it('handles image upload correctly', async () => {
    renderComponent();
    
    await waitFor(() => {
      expect(apiClient.get).toHaveBeenCalled();
    });
    
    // Click on Create News button
    fireEvent.click(screen.getByText('Create News'));
    
    // Create a test file
    const file = new File(['test image content'], 'test-image.jpg', { type: 'image/jpeg' });
    
    // Find the image upload input and upload a file
    const uploadButton = screen.getByText('Upload Image');
    const fileInput = uploadButton.closest('label').querySelector('input');
    fireEvent.change(fileInput, { target: { files: [file] } });
    
    // Image preview should be visible
    await waitFor(() => {
      expect(screen.getByText('Featured image uploaded successfully')).toBeInTheDocument();
      expect(screen.getByText('Change Image')).toBeInTheDocument();
    });
  });

  it('handles PDF attachment upload correctly', async () => {
    renderComponent();
    
    await waitFor(() => {
      expect(apiClient.get).toHaveBeenCalled();
    });
    
    // Click on Create News button
    fireEvent.click(screen.getByText('Create News'));
    
    // Create a test PDF file
    const file = new File(['test pdf content'], 'test-doc.pdf', { type: 'application/pdf' });
    
    // Find the PDF upload input and upload a file
    const uploadButton = screen.getByText('Upload PDF');
    const fileInput = uploadButton.closest('label').querySelector('input');
    fireEvent.change(fileInput, { target: { files: [file] } });
    
    // PDF preview should be visible
    await waitFor(() => {
      expect(screen.getByText('PDF document uploaded successfully')).toBeInTheDocument();
      expect(screen.getByText('Change PDF')).toBeInTheDocument();
      expect(screen.getByText('test-doc.pdf')).toBeInTheDocument();
    });
  });

  it('handles publication request for draft news', async () => {
    renderComponent();
    
    await waitFor(() => {
      expect(apiClient.get).toHaveBeenCalled();
    });
    
    // Click on View Details button of the first news (Draft status)
    const viewButtons = screen.getAllByText('View Details');
    fireEvent.click(viewButtons[0]);
    
    // Publication request button should be visible for draft news
    const requestButton = screen.getByTestId('publication-request-button');
    expect(requestButton).toBeInTheDocument();
    
    // Click on request button
    fireEvent.click(requestButton);
    
    // Status should be updated and news list refreshed
    await waitFor(() => {
      expect(apiClient.get).toHaveBeenCalledTimes(2);
    });
  });

  it('displays rejected news with admin feedback', async () => {
    renderComponent();
    
    await waitFor(() => {
      expect(apiClient.get).toHaveBeenCalled();
    });
    
    // Click on Rejected tab
    fireEvent.click(screen.getByText('Rejected'));
    
    // Click on View Details button of the rejected news
    const viewButtons = screen.getAllByText('View Details');
    fireEvent.click(viewButtons[0]);
    
    // Rejection notice and admin feedback should be visible
    expect(screen.getByText('This post was rejected by the admin')).toBeInTheDocument();
    expect(screen.getByText('Admin Feedback:')).toBeInTheDocument();
    expect(screen.getByText('Needs revision')).toBeInTheDocument();
    
    // Revise button should be available
    expect(screen.getByText('Revise and Resubmit')).toBeInTheDocument();
  });

  it('navigates back correctly from news details', async () => {
    renderComponent();
    
    await waitFor(() => {
      expect(apiClient.get).toHaveBeenCalled();
    });
    
    // Click on View Details button
    const viewButtons = screen.getAllByText('View Details');
    fireEvent.click(viewButtons[0]);
    
    // Click back button
    const backButton = screen.getByRole('button', { name: /arrowback/i });
    fireEvent.click(backButton);
    
    // Should go back to news list
    expect(screen.getByText('Society News Management')).toBeInTheDocument();
  });

  it('shows confirmation dialog when discarding changes', async () => {
    renderComponent();
    
    await waitFor(() => {
      expect(apiClient.get).toHaveBeenCalled();
    });
    
    // Click on Create News button
    fireEvent.click(screen.getByText('Create News'));
    
    // Fill in the form
    const titleInput = screen.getByPlaceholderText('Enter compelling title...');
    fireEvent.change(titleInput, { target: { value: 'New Test News' } });
    
    // Click cancel button
    const cancelButton = screen.getByText('Cancel');
    fireEvent.click(cancelButton);
    
    // Confirm dialog should appear
    expect(window.confirm).toHaveBeenCalledWith('Discard changes?');
    
    // Should go back to news list
    expect(screen.getByText('Society News Management')).toBeInTheDocument();
  });

  it('calls the onBack prop if provided', async () => {
    const onBackMock = vi.fn();
    renderComponent({ onBack: onBackMock });
    
    await waitFor(() => {
      expect(apiClient.get).toHaveBeenCalled();
    });
    
    // Click back button from the main news list
    const backButton = screen.getByRole('button', { name: /arrowback/i });
    fireEvent.click(backButton);
    
    // onBack should be called
    expect(onBackMock).toHaveBeenCalledTimes(1);
  });

  it('toggles pin and feature switches correctly', async () => {
    renderComponent();
    
    await waitFor(() => {
      expect(apiClient.get).toHaveBeenCalled();
    });
    
    // Click on Create News button
    fireEvent.click(screen.getByText('Create News'));
    
    // Find switches
    const pinSwitch = screen.getByText('Pin to top').closest('label').querySelector('input');
    const featureSwitch = screen.getByText('Feature this post').closest('label').querySelector('input');
    
    // Check initial state
    expect(pinSwitch).not.toBeChecked();
    expect(featureSwitch).not.toBeChecked();
    
    // Toggle switches
    fireEvent.click(pinSwitch);
    fireEvent.click(featureSwitch);
    
    // Check updated state
    expect(pinSwitch).toBeChecked();
    expect(featureSwitch).toBeChecked();
  });

  it('handles PDF view in the news details', async () => {
    renderComponent();
    
    await waitFor(() => {
      expect(apiClient.get).toHaveBeenCalled();
    });
    
    // Click on View Details button of the second news (has PDF attachment)
    const viewButtons = screen.getAllByText('View Details');
    fireEvent.click(viewButtons[1]);
    
    // PDF attachment should be visible
    expect(screen.getByText('Attachment')).toBeInTheDocument();
    
    // Click on View PDF button
    const viewPdfButton = screen.getByText(/View PDF:/);
    fireEvent.click(viewPdfButton);
    
    // window.open should be called with PDF URL
    expect(window.open).toHaveBeenCalledWith('https://example.com/test.pdf', '_blank');
  });

  it('validates form submission - disables submit button when required fields are empty', async () => {
    renderComponent();
    
    await waitFor(() => {
      expect(apiClient.get).toHaveBeenCalled();
    });
    
    // Click on Create News button
    fireEvent.click(screen.getByText('Create News'));
    
    // Submit button should be disabled initially (empty title & content)
    const submitButton = screen.getByText('Save Draft');
    expect(submitButton).toBeDisabled();
    
    // Fill title but not content
    const titleInput = screen.getByPlaceholderText('Enter compelling title...');
    fireEvent.change(titleInput, { target: { value: 'New Test News' } });
    
    // Button should still be disabled
    expect(submitButton).toBeDisabled();
    
    // Fill content
    const editorInput = screen.getByTestId('mock-editor');
    fireEvent.change(editorInput, { target: { value: '<p>New test content</p>' } });
    
    // Button should be enabled now
    expect(submitButton).not.toBeDisabled();
  });
});